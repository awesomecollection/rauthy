import"./disclose-version.BDr9Qe-U.js";import{p as M,v as P,F as U,u as l,f as N,a as q,w as B,c as n,r as c,s as S,t as x}from"./runtime.BONl2e88.js";import{s as E}from"./render.AqJWcVDb.js";import{i as j}from"./if.DS90EFHs.js";import{e as T,a as g,t as z}from"./template.B7ldVCvc.js";import{p as G}from"./proxy.0BECmVET.js";import{o as Q}from"./index-client.Bjp_k6xO.js";import{a as _,L as V}from"./fetch.JUNnB5kv.js";import{L as X,M as Y,p as Z,N as D}from"./helpers.CQGRRstl.js";import{u as ee}from"./i18n.svelte.B1gwAzk0.js";function re(i){let t=Y(i);const s={"+":"-","/":"_","=":""};return t.replace(/[+/=]/g,e=>s[e])}function R(i){if(typeof i=="string"){const t={"-":"+",_:"/",".":"="},s=i.replace(/[-_.]/g,e=>t[e]);return X(s)}else return i}async function ae(i,t,s,e){var k;let w={purpose:t},u=await _(`/auth/v1/users/${i}/webauthn/auth/start`,w);if(u.error)return console.error(u.error),{error:u.error.message||"Error starting the Authentication"};if(!u.body){let r="Did not receive a valid webauthn body";return console.error(r),{error:r}}let y=u.body,a=y.rcr;if(!a.publicKey){let r="no publicKey in challenge from the backend";return console.error(r),{error:r}}if(a.publicKey.challenge=R(a.publicKey.challenge),a.publicKey.allowCredentials)for(let r of a.publicKey.allowCredentials)r.id=R(r.id);const f=(y.exp-1)*1e3,b=new Date().getTime()+f;let o;try{const r=await Z(navigator.credentials.get(a),f);if(r)o=r;else return{error:s}}catch{return{error:new Date().getTime()>=b?e:s}}let h={code:y.code,data:{id:o.id,rawId:D(o.rawId),response:{authenticatorData:D(o.response.authenticatorData),clientDataJSON:D(o.response.clientDataJSON),signature:D(o.response.signature)},extensions:o.getClientExtensionResults(),type:o.type}},v=await _(`/auth/v1/users/${i}/webauthn/auth/finish`,h);return v.status===202?{data:v.body}:(console.error(v),{error:((k=v.error)==null?void 0:k.message)||"Authentication Error"})}var te=z('<div class="err svelte-jfkcym"> </div>'),se=z('<div class="good svelte-jfkcym"> </div>'),oe=z('<div class="wrapperOuter svelte-jfkcym"><div class="wrapperInner svelte-jfkcym"><div class="content svelte-jfkcym"><div class="contentRow svelte-jfkcym"><div class="contentHeader svelte-jfkcym"> </div></div> <div class="contentRow svelte-jfkcym"><div><!></div></div> <div class="contentRow svelte-jfkcym"><!></div></div></div></div>');function ie(i,t){M(t,!0);let s=ee(),e=B(void 0);Q(async()=>{P(e,G(await ae(t.userId,t.purpose,s.authorize.invalidKeyUsed,s.authorize.requestExpired)))}),U(()=>{l(e)&&(l(e).error?setTimeout(()=>{var a;t.onError(((a=l(e))==null?void 0:a.error)||"Webauthn Error")},3e3):t.onSuccess(l(e).data))});var w=T(),u=N(w);{var y=a=>{var f=oe(),b=n(f),o=n(b),h=n(o),v=n(h),k=n(v,!0);c(v),c(h);var r=S(h,2),A=n(r),J=n(A);{var O=d=>{V(d,{})};j(J,d=>{l(e)||d(O)})}c(A),c(r);var C=S(r,2),W=n(C);{var $=d=>{var I=T(),F=N(I);{var H=m=>{var p=te(),K=n(p,!0);c(p),x(()=>E(K,l(e).error)),g(m,p)},L=m=>{var p=se(),K=n(p,!0);c(p),x(()=>E(K,s.authorize.mfaAck)),g(m,p)};j(F,m=>{l(e).error?m(H):m(L,!1)})}g(d,I)};j(W,d=>{l(e)&&d($)})}c(C),c(o),c(b),c(f),x(()=>E(k,s.authorize.expectingPasskey)),g(a,f)};j(u,a=>{t.purpose&&a(y)})}g(i,w),q()}export{ie as W,re as a,R as b};
