import"../chunks/disclose-version.BDr9Qe-U.js";import{p as as,P as y,o as ts,Q as W,a as os,j as s,T as m,$ as Ne,g as e,R as o,U as R,W as C,V as b,h as is}from"../chunks/index-client.CzqVbBUo.js";import{s as u}from"../chunks/render.CK5MTJQL.js";import{p as d,i as $}from"../chunks/if.BnegfJmL.js";import{a as t,t as q,c as Z,b as L}from"../chunks/template.io25wnf1.js";import{h as ds}from"../chunks/svelte-head.BSz900xL.js";import{B as F,s as He,t as Te,a as Ve}from"../chunks/Button.JzTZa4bh.js";import{s as ns}from"../chunks/helpers.BvaXa0cv.js";import{r as ge}from"../chunks/legacy-client.DPLAlLYD.js";import{c as Ge,a as Ke,I as ls}from"../chunks/Input.jkTumKYK.js";import{A as ps,v as cs,B as us,o as Me,D as ws,E as vs,F as ms,G as De,H as Ee,I as fs}from"../chunks/dataFetching.Br47vc1D.js";import{P as Qe}from"../chunks/PasswordPolicy.DbNoBlQZ.js";import{P as he}from"../chunks/PasswordInput.DOldwDot.js";import{W as Ye}from"../chunks/WebauthnRequest.DHqnsBvK.js";import{L as gs}from"../chunks/LangSelector.DQTzLAdQ.js";import"../chunks/is_dev.svelte.qp6n2kD5.js";import{u as hs}from"../chunks/i18n.svelte.C_qSL0ZA.js";import{M as ys,C as $s}from"../chunks/ContentCenter.B2VsFG_i.js";import{T as _s}from"../chunks/Template.mSBxkRZ-.js";var ks=q('<div class="success svelte-14344wy"> <br> </div>'),Rs=q("<div><!> <!> <!> <!> <!> <!></div>"),Cs=q('<div class="success svelte-14344wy"><p> </p> <p> </p> <!></div>'),bs=q("<div><!> <!> <!></div>"),Ls=q('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-14344wy">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),Ns=q('<div class="success svelte-14344wy"> <br> <br> <a class="svelte-14344wy">Link</a></div>'),Ks=q("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),Ds=q('<div class="err svelte-14344wy"> </div>'),Es=q('<div class="container"><!> <!></div>'),xs=q("<!> <!> <!>",1);function Ps(Be,Xe){as(Xe,!0);const J="150px",z="320px";let r=hs(),p=y(void 0),N=y(!1),K=y(""),ee=y(""),se=y(""),re=y(""),g=y(!1),ae=y(!1),te=y(!1),A=y(void 0),i=y(d({passkeyName:"",password:"",passwordConfirm:""})),P=y(d({})),xe=y(void 0),Pe=y(void 0);ts(async()=>{s(ee,"password_reset")});function qe(){window.location.replace("/auth/v1/account")}function Ae(){if(e(p)){const w=e(p).password_policy.length_min>24?e(p).password_policy.length_min:24;let _=us(w,e(p).password_policy.include_lower_case,e(p).password_policy.include_upper_case,e(p).password_policy.include_digits,e(p).password_policy.include_special);e(i).password=_,e(i).passwordConfirm=_}}async function Ie(){if(!e(p)){console.error("template data is undefined");return}s(K,"");try{await e(xe).validate(e(i),{abortEarly:!1}),s(P,d({}))}catch(n){s(P,d(Me(n)));return}const w=e(i).passkeyName;if(w.length<2){s(K,d(r.mfa.passkeyNameErr));return}let _={passkey_name:w,magic_link_id:e(p).magic_link_id},f=await ms(e(p).user_id,_,e(p).csrf_token);if(f.status===200){let n=await f.json();n.publicKey.authenticatorSelection.userVerification="required",n.publicKey.challenge=De(n.publicKey.challenge),n.publicKey.user.id=De(n.publicKey.user.id),n.publicKey.excludeCredentials=n.publicKey.excludeCredentials,n.publicKey.excludeCredentials&&(n.publicKey.excludeCredentials=n.publicKey.excludeCredentials.map(O=>(O.id=De(O.id),O)));let D=await navigator.credentials.create(n),I={passkey_name:w,data:{id:D.id,rawId:Ee(D.rawId),response:{attestationObject:Ee(D.response.attestationObject),clientDataJSON:Ee(D.response.clientDataJSON)},type:D.type},magic_link_id:e(p).magic_link_id};f=await fs(userId,I,e(p).csrf_token),f.status===201?(s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(g,!0)):(pe(),console.error(f))}else{pe();let n=await f.json();console.error(n.error),console.error(n.message)}}async function je(){var w,_;try{await e(Pe).validate(e(i),{abortEarly:!1}),s(P,d({}))}catch(f){s(P,d(Me(f)));return}if(e(ae)){if(e(i).password.length>256){s(K,"max 256");return}if(e(i).password!==e(i).passwordConfirm){s(K,d(r.passwordReset.passwordNoMatch));return}else s(K,"");if((w=e(p))!=null&&w.needs_mfa){let f=await ws((_=e(p))==null?void 0:_.user_id,{purpose:"PasswordReset"}),n=await f.json();if(!f.ok){s(K,d(n.message)),s(N,!1);return}if(n.user_id!==e(p).user_id){s(K,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(A,d(n))}else await Se()}}async function Se(w){var n;if(!e(p))return;s(N,!0);const _={password:e(i).password,magic_link_id:e(p).magic_link_id,mfa_code:w},f=await vs(e(p).user_id,_,(n=e(p))==null?void 0:n.csrf_token);if(f.ok)s(K,""),s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(re,d(f.headers.get("Location"))),console.log("redirectUri: "+e(re)),s(g,!0);else{const D=await f.json();s(K,d(D.message))}s(N,!1)}function pe(){s(A,void 0),s(K,d(r.mfa.errorReg))}function Ue(w){w&&(s(A,void 0),Se(w.code))}ge(()=>{r&&(s(xe,d(Ge().shape({passkeyName:Ke().required(r.common.required).matches(cs,r.mfa.passkeyNameErr)}))),s(Pe,d(Ge().shape({password:Ke().required(r.common.required),passwordConfirm:Ke().required(r.common.required)}))))}),ge(()=>{e(se)&&s(i,d({passkeyName:"",password:"",passwordConfirm:""}))}),ge(()=>{var w;((w=e(i).password)==null?void 0:w.length)>0&&e(i).password===e(i).passwordConfirm&&s(te,!0)}),ge(()=>{e(g)&&setTimeout(()=>{e(re)?window.location.replace(e(re)):qe()},5e3)});var We=xs();ds(w=>{var _=Z(),f=W(_);{var n=I=>{var O=Z(),oe=W(O);{var ie=H=>{m(()=>Ne.title=r.passwordReset.newAccount)},ce=H=>{var ue=Z(),ye=W(ue);{var $e=k=>{m(()=>Ne.title=r.passwordReset.passwordReset)};$(ye,k=>{e(ee)==="password_reset"&&k($e)},!0)}t(H,ue)};$(oe,H=>{e(ee).startsWith("new_user")?H(ie):H(ce,!1)})}t(I,O)},D=I=>{Ne.title="Password"};$(f,I=>{r?I(n):I(D,!1)})}t(w,_)});var Je=W(We);_s(Je,{id:ps,get value(){return e(p)},set value(w){s(p,d(w))}});var Oe=o(Je,2);ys(Oe,{children:(w,_)=>{$s(w,{children:(f,n)=>{var D=Z(),I=W(D);{var O=oe=>{var ie=Es(),ce=R(ie);{var H=k=>{var j=Ls(),Q=W(j);{var _e=a=>{Ye(a,{onSuccess:Ue,onError:pe,get data(){return e(A)},set data(h){s(A,d(h))}})};$(Q,a=>{e(A)&&a(_e)})}var T=o(Q,2),we=R(T,!0);C(T);var Y=o(T,2),ke=R(Y,!0);C(Y);var B=o(Y,2),de=R(B,!0),ve=o(de);C(B);var V=o(B,2);ns(V,"margin-bottom","1rem");var ne=R(V);F(ne,{width:J,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(se,"passkey")},children:(a,h)=>{b();var E=L();m(()=>u(E,r.passwordReset.passwordless)),t(a,E)},$$slots:{default:!0}});var Re=o(ne,2);F(Re,{width:J,level:3,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(se,"password")},children:(a,h)=>{b();var E=L();m(()=>u(E,r.passwordReset.password)),t(a,E)},$$slots:{default:!0}}),C(V);var Ce=o(V,2);{var c=a=>{var h=Rs(),E=R(h);Qe(E,{get policy(){return e(p).password_policy},get password(){return e(i).password},get accepted(){return e(ae)},set accepted(v){s(ae,d(v))}});var me=o(E,2);he(me,{get error(){return e(P).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:z,get showCopy(){return e(te)},get disabled(){return e(g)},get value(){return e(i).password},set value(v){e(i).password=v},children:(v,S)=>{b();var l=L();m(()=>u(l,r.passwordReset.password.toUpperCase())),t(v,l)},$$slots:{default:!0}});var X=o(me,2);he(X,{get error(){return e(P).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:z,get showCopy(){return e(te)},get disabled(){return e(g)},get value(){return e(i).passwordConfirm},set value(v){e(i).passwordConfirm=v},children:(v,S)=>{b();var l=L();m(()=>u(l,r.passwordReset.passwordConfirm.toUpperCase())),t(v,l)},$$slots:{default:!0}});var G=o(X,2);F(G,{width:J,level:3,get isDisabled(){return e(g)},$$events:{click:Ae},children:(v,S)=>{b();var l=L();m(()=>u(l,r.passwordReset.generate)),t(v,l)},$$slots:{default:!0}});var le=o(G,2);F(le,{width:J,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(v){s(N,d(v))},$$events:{click:je},children:(v,S)=>{b();var l=L();m(()=>u(l,r.common.save)),t(v,l)},$$slots:{default:!0}});var fe=o(le,2);{var be=v=>{var S=ks(),l=R(S),M=o(l,2);C(S),m(()=>{u(l,`${r.passwordReset.success1??""} `),u(M,` ${r.passwordReset.success2??""}`)}),t(v,S)};$(fe,v=>{e(g)&&v(be)})}C(h),Te(3,h,()=>Ve),t(a,h)},x=a=>{var h=Z(),E=W(h);{var me=X=>{var G=bs(),le=R(G);ls(le,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:z,get disabled(){return e(g)},get value(){return e(i).passkeyName},set value(l){e(i).passkeyName=l},get error(){return e(P).passkeyName},set error(l){e(P).passkeyName=l},$$events:{enter:Ie},children:(l,M)=>{b();var U=L();m(()=>u(U,r.mfa.passkeyName)),t(l,U)},$$slots:{default:!0}});var fe=o(le,2),be=is(()=>e(g)?2:1);F(fe,{width:J,get level(){return e(be)},get isDisabled(){return e(g)},$$events:{click:Ie},children:(l,M)=>{b();var U=L();m(()=>u(U,r.mfa.register)),t(l,U)},$$slots:{default:!0}});var v=o(fe,2);{var S=l=>{var M=Cs(),U=R(M),ze=R(U,!0);C(U);var Le=o(U,2),es=R(Le,!0);C(Le);var ss=o(Le,2);F(ss,{width:J,level:1,$$events:{click:qe},children:(rs,qs)=>{b();var Fe=L();m(()=>u(Fe,r.passwordReset.accountLogin)),t(rs,Fe)},$$slots:{default:!0}}),C(M),m(()=>{u(ze,r.passwordReset.successPasskey1),u(es,r.passwordReset.successPasskey2)}),t(l,M)};$(v,l=>{e(g)&&l(S)})}C(G),Te(3,G,()=>Ve),t(X,G)};$(E,X=>{e(se)==="passkey"&&X(me)},!0)}t(a,h)};$(Ce,a=>{e(se)==="password"?a(c):a(x,!1)})}m(()=>{u(we,r.passwordReset.newAccount),u(ke,r.passwordReset.newAccDesc1),u(de,r.passwordReset.newAccDesc2),He(ve,"href",r.passwordReset.fidoLink)}),t(k,j)},ue=k=>{var j=Z(),Q=W(j);{var _e=T=>{var we=Ks(),Y=W(we);{var ke=c=>{Ye(c,{purpose:"PasswordReset",onSuccess:Ue,onError:pe,get data(){return e(A)},set data(x){s(A,d(x))}})};$(Y,c=>{e(A)&&c(ke)})}var B=o(Y,4);Qe(B,{get policy(){return e(p).password_policy},get password(){return e(i).password},get accepted(){return e(ae)},set accepted(c){s(ae,d(c))}});var de=o(B,2);he(de,{get error(){return e(P).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:z,get showCopy(){return e(te)},get value(){return e(i).password},set value(c){e(i).password=c},children:(c,x)=>{b();var a=L();m(()=>u(a,r.passwordReset.password.toUpperCase())),t(c,a)},$$slots:{default:!0}});var ve=o(de,2);he(ve,{get error(){return e(P).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:z,get showCopy(){return e(te)},get value(){return e(i).passwordConfirm},set value(c){e(i).passwordConfirm=c},children:(c,x)=>{b();var a=L();m(()=>u(a,r.passwordReset.passwordConfirm.toUpperCase())),t(c,a)},$$slots:{default:!0}});var V=o(ve,2);F(V,{width:J,level:3,$$events:{click:Ae},children:(c,x)=>{b();var a=L();m(()=>u(a,r.passwordReset.generate)),t(c,a)},$$slots:{default:!0}});var ne=o(V,2);F(ne,{width:J,level:2,get isLoading(){return e(N)},set isLoading(c){s(N,d(c))},$$events:{click:je},children:(c,x)=>{b();var a=L();m(()=>u(a,r.common.save)),t(c,a)},$$slots:{default:!0}});var Re=o(ne,2);{var Ce=c=>{var x=Ns(),a=R(x),h=o(a,2),E=o(h,3);C(x),m(()=>{u(a,`${r.passwordReset.success1??""}
                            ${r.passwordReset.success2??""} `),u(h,` ${r.passwordReset.success3??""} `),He(E,"href",e(re)||"/auth/v1/account")}),t(c,x)};$(Re,c=>{e(g)&&c(Ce)})}t(T,we)};$(Q,T=>{e(ee).startsWith("password_reset")&&T(_e)},!0)}t(k,j)};$(ce,k=>{e(ee).startsWith("new_user")?k(H):k(ue,!1)})}var ye=o(ce,2);{var $e=k=>{var j=Ds(),Q=R(j,!0);C(j),m(()=>u(Q,e(K))),t(k,j)};$(ye,k=>{e(K)&&k($e)})}C(ie),t(oe,ie)};$(I,oe=>{e(p)&&oe(O)})}t(f,D)},$$slots:{default:!0}})},$$slots:{default:!0}});var Ze=o(Oe,2);gs(Ze,{absolute:!0}),t(Be,We),os()}export{Ps as component};
