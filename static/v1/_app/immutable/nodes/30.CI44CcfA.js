import"../chunks/disclose-version.BDr9Qe-U.js";import{p as ts,a3 as y,o as os,a4 as O,a as is,j as s,a6 as m,$ as De,g as e,a5 as t,a7 as k,a9 as R,a8 as C,h as ds}from"../chunks/index-client.Bsb9hq-M.js";import{s as u}from"../chunks/render.Cl_nSOQQ.js";import{i as $}from"../chunks/if.Mw_hWmq0.js";import{a as o,t as K,c as pe,b}from"../chunks/template.D54H5ZkF.js";import{h as ns}from"../chunks/svelte-head.YbFS2hoE.js";import{s as ps,a as Te,b as Ve,c as Xe}from"../chunks/index.DiuQmtU3.js";import{p as d}from"../chunks/proxy.DclUEOHG.js";import{r as ge}from"../chunks/legacy-client.QbOhT8wP.js";import{c as ze,a as qe,I as ls}from"../chunks/Input.BHI3aq7I.js";import{u as cs,n as us,v as ws,k as He,w as xe,x as Ke}from"../chunks/helpers.Cfg4Q1a_.js";import{w as vs,d as ms,e as fs,f as gs}from"../chunks/dataFetching.D_YOETHp.js";import{B as F}from"../chunks/Button.BbZR8hhL.js";import{P as Me}from"../chunks/PasswordPolicy.0ZfnAjGI.js";import{P as he}from"../chunks/PasswordInput.B_ynErOb.js";import{W as Be}from"../chunks/WebauthnRequest.CFGMqx9K.js";import{L as hs}from"../chunks/LangSelector.4aRmjdrU.js";import"../chunks/is_dev.svelte.Bsag8ZOP.js";import{u as ys}from"../chunks/i18n.svelte.B0RF3bDg.js";import{M as $s,C as _s}from"../chunks/ContentCenter.Dpb8rCa1.js";import{T as ks}from"../chunks/Template.CCszvfWi.js";import"../chunks/param.svelte.CjFurolb.js";import{T as Rs}from"../chunks/ThemeSwitch.Zeh_8WtX.js";var Cs=K('<div class="success svelte-14344wy"> <br> </div>'),bs=K("<div><!> <!> <!> <!> <!> <!></div>"),Ns=K('<div class="success svelte-14344wy"><p> </p> <p> </p> <!></div>'),Ls=K("<div><!> <!> <!></div>"),Ds=K('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-14344wy">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),qs=K('<div class="success svelte-14344wy"> <br> <br> <a class="svelte-14344wy">Link</a></div>'),xs=K("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),Ks=K('<div class="err svelte-14344wy"> </div>'),Ps=K('<div class="container"><!> <!></div>'),As=K("<!> <!>",1),Is=K("<!> <!> <!>",1);function js(Ze,Qe){ts(Qe,!0);const U="150px",Q="320px";let r=ys(),l=y(void 0),N=y(!1),L=y(""),Y=y(""),ee=y(""),se=y(""),g=y(!1),re=y(!1),ae=y(!1),j=y(void 0),i=y(d({passkeyName:"",password:"",passwordConfirm:""})),P=y(d({})),Pe=y(void 0),Ae=y(void 0);os(async()=>{s(Y,"password_reset")});function Ie(){window.location.replace("/auth/v1/account")}function je(){if(e(l)){const w=e(l).password_policy.length_min>24?e(l).password_policy.length_min:24;let _=ws(w,e(l).password_policy.include_lower_case,e(l).password_policy.include_upper_case,e(l).password_policy.include_digits,e(l).password_policy.include_special);e(i).password=_,e(i).passwordConfirm=_}}async function Ee(){if(!e(l)){console.error("template data is undefined");return}s(L,"");try{await e(Pe).validate(e(i),{abortEarly:!1}),s(P,d({}))}catch(n){s(P,d(He(n)));return}const w=e(i).passkeyName;if(w.length<2){s(L,d(r.mfa.passkeyNameErr));return}let _={passkey_name:w,magic_link_id:e(l).magic_link_id},f=await fs(e(l).user_id,_,e(l).csrf_token);if(f.status===200){let n=await f.json();n.publicKey.authenticatorSelection.userVerification="required",n.publicKey.challenge=xe(n.publicKey.challenge),n.publicKey.user.id=xe(n.publicKey.user.id),n.publicKey.excludeCredentials=n.publicKey.excludeCredentials,n.publicKey.excludeCredentials&&(n.publicKey.excludeCredentials=n.publicKey.excludeCredentials.map(G=>(G.id=xe(G.id),G)));let D=await navigator.credentials.create(n),A={passkey_name:w,data:{id:D.id,rawId:Ke(D.rawId),response:{attestationObject:Ke(D.response.attestationObject),clientDataJSON:Ke(D.response.clientDataJSON)},type:D.type},magic_link_id:e(l).magic_link_id};f=await gs(userId,A,e(l).csrf_token),f.status===201?(s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(g,!0)):(le(),console.error(f))}else{le();let n=await f.json();console.error(n.error),console.error(n.message)}}async function Se(){var w,_;try{await e(Ae).validate(e(i),{abortEarly:!1}),s(P,d({}))}catch(f){s(P,d(He(f)));return}if(e(re)){if(e(i).password.length>256){s(L,"max 256");return}if(e(i).password!==e(i).passwordConfirm){s(L,d(r.passwordReset.passwordNoMatch));return}else s(L,"");if((w=e(l))!=null&&w.needs_mfa){let f=await vs((_=e(l))==null?void 0:_.user_id,{purpose:"PasswordReset"}),n=await f.json();if(!f.ok){s(L,d(n.message)),s(N,!1);return}if(n.user_id!==e(l).user_id){s(L,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(j,d(n))}else await We()}}async function We(w){var n;if(!e(l))return;s(N,!0);const _={password:e(i).password,magic_link_id:e(l).magic_link_id,mfa_code:w},f=await ms(e(l).user_id,_,(n=e(l))==null?void 0:n.csrf_token);if(f.ok)s(L,""),s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(se,d(f.headers.get("Location"))),console.log("redirectUri: "+e(se)),s(g,!0);else{const D=await f.json();s(L,d(D.message))}s(N,!1)}function le(){s(j,void 0),s(L,d(r.mfa.errorReg))}function Oe(w){w&&(s(j,void 0),We(w.code))}ge(()=>{r&&(s(Pe,d(ze().shape({passkeyName:qe().required(r.common.required).matches(us,r.mfa.passkeyNameErr)}))),s(Ae,d(ze().shape({password:qe().required(r.common.required),passwordConfirm:qe().required(r.common.required)}))))}),ge(()=>{e(ee)&&s(i,d({passkeyName:"",password:"",passwordConfirm:""}))}),ge(()=>{var w;((w=e(i).password)==null?void 0:w.length)>0&&e(i).password===e(i).passwordConfirm&&s(ae,!0)}),ge(()=>{e(g)&&setTimeout(()=>{e(se)?window.location.replace(e(se)):Ie()},5e3)});var Ue=Is();ns(w=>{var _=pe(),f=O(_);{var n=A=>{var G=pe(),ye=O(G);{var te=J=>{m(()=>De.title=r.passwordReset.newAccount)},oe=J=>{var ce=pe(),$e=O(ce);{var _e=ue=>{m(()=>De.title=r.passwordReset.passwordReset)};$($e,ue=>{e(Y)==="password_reset"&&ue(_e)},!0)}o(J,ce)};$(ye,J=>{e(Y).startsWith("new_user")?J(te):J(oe,!1)})}o(A,G)},D=A=>{De.title="Password"};$(f,A=>{r?A(n):A(D,!1)})}o(w,_)});var Ge=O(Ue);ks(Ge,{id:cs,get value(){return e(l)},set value(w){s(l,d(w))}});var Je=t(Ge,2);$s(Je,{children:(w,_)=>{_s(w,{children:(f,n)=>{var D=As(),A=O(D);{var G=te=>{var oe=Ps(),J=k(oe);{var ce=I=>{var E=Ds(),H=O(E);{var ke=a=>{Be(a,{onSuccess:Oe,onError:le,get data(){return e(j)},set data(h){s(j,d(h))}})};$(H,a=>{e(j)&&a(ke)})}var T=t(H,2),we=k(T,!0);R(T);var M=t(T,2),Re=k(M,!0);R(M);var B=t(M,2),ie=k(B,!0),ve=t(ie);R(B);var V=t(B,2);ps(V,"margin-bottom","1rem");var de=k(V);F(de,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(ee,"passkey")},children:(a,h)=>{C();var q=b();m(()=>u(q,r.passwordReset.passwordless)),o(a,q)},$$slots:{default:!0}});var Ce=t(de,2);F(Ce,{width:U,level:3,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(ee,"password")},children:(a,h)=>{C();var q=b();m(()=>u(q,r.passwordReset.password)),o(a,q)},$$slots:{default:!0}}),R(V);var be=t(V,2);{var c=a=>{var h=bs(),q=k(h);Me(q,{get policy(){return e(l).password_policy},get password(){return e(i).password},get accepted(){return e(re)},set accepted(v){s(re,d(v))}});var me=t(q,2);he(me,{get error(){return e(P).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(ae)},get disabled(){return e(g)},get value(){return e(i).password},set value(v){e(i).password=v},children:(v,S)=>{C();var p=b();m(()=>u(p,r.passwordReset.password.toUpperCase())),o(v,p)},$$slots:{default:!0}});var Z=t(me,2);he(Z,{get error(){return e(P).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(ae)},get disabled(){return e(g)},get value(){return e(i).passwordConfirm},set value(v){e(i).passwordConfirm=v},children:(v,S)=>{C();var p=b();m(()=>u(p,r.passwordReset.passwordConfirm.toUpperCase())),o(v,p)},$$slots:{default:!0}});var X=t(Z,2);F(X,{width:U,level:3,get isDisabled(){return e(g)},$$events:{click:je},children:(v,S)=>{C();var p=b();m(()=>u(p,r.passwordReset.generate)),o(v,p)},$$slots:{default:!0}});var ne=t(X,2);F(ne,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(v){s(N,d(v))},$$events:{click:Se},children:(v,S)=>{C();var p=b();m(()=>u(p,r.common.save)),o(v,p)},$$slots:{default:!0}});var fe=t(ne,2);{var Ne=v=>{var S=Cs(),p=k(S),z=t(p,2);R(S),m(()=>{u(p,`${r.passwordReset.success1??""} `),u(z,` ${r.passwordReset.success2??""}`)}),o(v,S)};$(fe,v=>{e(g)&&v(Ne)})}R(h),Ve(3,h,()=>Xe),o(a,h)},x=a=>{var h=pe(),q=O(h);{var me=Z=>{var X=Ls(),ne=k(X);ls(ne,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:Q,get disabled(){return e(g)},get value(){return e(i).passkeyName},set value(p){e(i).passkeyName=p},get error(){return e(P).passkeyName},set error(p){e(P).passkeyName=p},$$events:{enter:Ee},children:(p,z)=>{C();var W=b();m(()=>u(W,r.mfa.passkeyName)),o(p,W)},$$slots:{default:!0}});var fe=t(ne,2),Ne=ds(()=>e(g)?2:1);F(fe,{width:U,get level(){return e(Ne)},get isDisabled(){return e(g)},$$events:{click:Ee},children:(p,z)=>{C();var W=b();m(()=>u(W,r.mfa.register)),o(p,W)},$$slots:{default:!0}});var v=t(fe,2);{var S=p=>{var z=Ns(),W=k(z),es=k(W,!0);R(W);var Le=t(W,2),ss=k(Le,!0);R(Le);var rs=t(Le,2);F(rs,{width:U,level:1,$$events:{click:Ie},children:(as,Es)=>{C();var Fe=b();m(()=>u(Fe,r.passwordReset.accountLogin)),o(as,Fe)},$$slots:{default:!0}}),R(z),m(()=>{u(es,r.passwordReset.successPasskey1),u(ss,r.passwordReset.successPasskey2)}),o(p,z)};$(v,p=>{e(g)&&p(S)})}R(X),Ve(3,X,()=>Xe),o(Z,X)};$(q,Z=>{e(ee)==="passkey"&&Z(me)},!0)}o(a,h)};$(be,a=>{e(ee)==="password"?a(c):a(x,!1)})}m(()=>{u(we,r.passwordReset.newAccount),u(Re,r.passwordReset.newAccDesc1),u(ie,r.passwordReset.newAccDesc2),Te(ve,"href",r.passwordReset.fidoLink)}),o(I,E)},$e=I=>{var E=pe(),H=O(E);{var ke=T=>{var we=xs(),M=O(we);{var Re=c=>{Be(c,{purpose:"PasswordReset",onSuccess:Oe,onError:le,get data(){return e(j)},set data(x){s(j,d(x))}})};$(M,c=>{e(j)&&c(Re)})}var B=t(M,4);Me(B,{get policy(){return e(l).password_policy},get password(){return e(i).password},get accepted(){return e(re)},set accepted(c){s(re,d(c))}});var ie=t(B,2);he(ie,{get error(){return e(P).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(ae)},get value(){return e(i).password},set value(c){e(i).password=c},children:(c,x)=>{C();var a=b();m(()=>u(a,r.passwordReset.password.toUpperCase())),o(c,a)},$$slots:{default:!0}});var ve=t(ie,2);he(ve,{get error(){return e(P).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(ae)},get value(){return e(i).passwordConfirm},set value(c){e(i).passwordConfirm=c},children:(c,x)=>{C();var a=b();m(()=>u(a,r.passwordReset.passwordConfirm.toUpperCase())),o(c,a)},$$slots:{default:!0}});var V=t(ve,2);F(V,{width:U,level:3,$$events:{click:je},children:(c,x)=>{C();var a=b();m(()=>u(a,r.passwordReset.generate)),o(c,a)},$$slots:{default:!0}});var de=t(V,2);F(de,{width:U,level:2,get isLoading(){return e(N)},set isLoading(c){s(N,d(c))},$$events:{click:Se},children:(c,x)=>{C();var a=b();m(()=>u(a,r.common.save)),o(c,a)},$$slots:{default:!0}});var Ce=t(de,2);{var be=c=>{var x=qs(),a=k(x),h=t(a,2),q=t(h,3);R(x),m(()=>{u(a,`${r.passwordReset.success1??""}
                            ${r.passwordReset.success2??""} `),u(h,` ${r.passwordReset.success3??""} `),Te(q,"href",e(se)||"/auth/v1/account")}),o(c,x)};$(Ce,c=>{e(g)&&c(be)})}o(T,we)};$(H,T=>{e(Y).startsWith("password_reset")&&T(ke)},!0)}o(I,E)};$(J,I=>{e(Y).startsWith("new_user")?I(ce):I($e,!1)})}var _e=t(J,2);{var ue=I=>{var E=Ks(),H=k(E,!0);R(E),m(()=>u(H,e(L))),o(I,E)};$(_e,I=>{e(L)&&I(ue)})}R(oe),o(te,oe)};$(A,te=>{e(l)&&te(G)})}var ye=t(A,2);Rs(ye,{absolute:!0}),o(f,D)},$$slots:{default:!0}})},$$slots:{default:!0}});var Ye=t(Je,2);hs(Ye,{absolute:!0}),o(Ze,Ue),is()}export{js as component};
