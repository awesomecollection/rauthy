import"../chunks/disclose-version.BDr9Qe-U.js";import{p as ts,a6 as y,o as os,a3 as O,a as is,j as s,a5 as m,$ as Le,g as e,a4 as t,a7 as k,a9 as R,a8 as C,h as ds}from"../chunks/index-client.C1uYfxHd.js";import{s as u}from"../chunks/render.DlGhCWX2.js";import{i as $}from"../chunks/if.DL6pUnI4.js";import{a as o,t as q,c as pe,b}from"../chunks/template.BehheIQn.js";import{h as ns}from"../chunks/svelte-head.76d9LV1R.js";import{s as ps,b as Fe,a as Te,c as Ve}from"../chunks/index.BcsnDkjo.js";import{p as i}from"../chunks/proxy.bZKuG6wn.js";import{r as ge}from"../chunks/legacy-client.CLGpwDPz.js";import{c as He,a as Ke,I as ls}from"../chunks/Input.CUOUCx9V.js";import{v as cs,o as us,w as ws,k as Me,x as xe,y as qe}from"../chunks/helpers.EoWe9H8J.js";import{w as vs,d as ms,e as fs,f as gs}from"../chunks/dataFetching.Dq7bE0Ok.js";import{B as z}from"../chunks/Button.BCobGyYN.js";import{P as Be}from"../chunks/PasswordPolicy.CJdZqFqF.js";import{P as he}from"../chunks/PasswordInput.UpF6iKp2.js";import{W as Qe}from"../chunks/WebauthnRequest.CziMDAcN.js";import{L as hs}from"../chunks/LangSelector.Bntt9KZe.js";import{T as ys,u as $s}from"../chunks/Template.DxkxrmTY.js";import{u as _s}from"../chunks/i18n.svelte.C5UT6hSp.js";import{M as ks,C as Rs}from"../chunks/ContentCenter.BU-nX73m.js";import{u as Cs}from"../chunks/param.svelte.vEd3x5XR.js";import{T as bs}from"../chunks/ThemeSwitch.B8t8VQsu.js";var Ns=q('<div class="success svelte-14344wy"> <br> </div>'),Ds=q("<div><!> <!> <!> <!> <!> <!></div>"),Ls=q('<div class="success svelte-14344wy"><p> </p> <p> </p> <!></div>'),Ks=q("<div><!> <!> <!></div>"),xs=q('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-14344wy">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),qs=q('<div class="success svelte-14344wy"> <br> <br> <a class="svelte-14344wy">Link</a></div>'),Ps=q("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),Ws=q('<div class="err svelte-14344wy"> </div>'),As=q('<div class="container"><!> <!></div>'),Es=q("<!> <!>",1),js=q("<!> <!> <!>",1);function Is(Xe,Ze){ts(Ze,!0);const U="150px",Y="320px";let r=_s(),l=y(void 0),N=y(!1),D=y(""),M=y(""),ee=y(""),se=y(""),g=y(!1),re=y(!1),ae=y(!1),E=y(void 0),d=y(i({passkeyName:"",password:"",passwordConfirm:""})),P=y(i({})),Pe=y(void 0),We=y(void 0);os(async()=>{$s().get()?s(M,"password_reset"):s(M,i(Cs("type").get()||"password_reset"))});function Ae(){window.location.replace("/auth/v1/account")}function Ee(){if(e(l)){const w=e(l).password_policy.length_min>24?e(l).password_policy.length_min:24;let _=ws(w,e(l).password_policy.include_lower_case,e(l).password_policy.include_upper_case,e(l).password_policy.include_digits,e(l).password_policy.include_special);e(d).password=_,e(d).passwordConfirm=_}}async function je(){if(!e(l)){console.error("template data is undefined");return}s(D,"");try{await e(Pe).validate(e(d),{abortEarly:!1}),s(P,i({}))}catch(n){s(P,i(Me(n)));return}const w=e(d).passkeyName;if(w.length<2){s(D,i(r.mfa.passkeyNameErr));return}let _={passkey_name:w,magic_link_id:e(l).magic_link_id},f=await fs(e(l).user_id,_,e(l).csrf_token);if(f.status===200){let n=await f.json();n.publicKey.authenticatorSelection.userVerification="required",n.publicKey.challenge=xe(n.publicKey.challenge),n.publicKey.user.id=xe(n.publicKey.user.id),n.publicKey.excludeCredentials=n.publicKey.excludeCredentials,n.publicKey.excludeCredentials&&(n.publicKey.excludeCredentials=n.publicKey.excludeCredentials.map(G=>(G.id=xe(G.id),G)));let L=await navigator.credentials.create(n),W={passkey_name:w,data:{id:L.id,rawId:qe(L.rawId),response:{attestationObject:qe(L.response.attestationObject),clientDataJSON:qe(L.response.clientDataJSON)},type:L.type},magic_link_id:e(l).magic_link_id};f=await gs(userId,W,e(l).csrf_token),f.status===201?(s(d,i({passkeyName:"",password:"",passwordConfirm:""})),s(g,!0)):(le(),console.error(f))}else{le();let n=await f.json();console.error(n.error),console.error(n.message)}}async function Ie(){var w,_;try{await e(We).validate(e(d),{abortEarly:!1}),s(P,i({}))}catch(f){s(P,i(Me(f)));return}if(e(re)){if(e(d).password.length>256){s(D,"max 256");return}if(e(d).password!==e(d).passwordConfirm){s(D,i(r.passwordReset.passwordNoMatch));return}else s(D,"");if((w=e(l))!=null&&w.needs_mfa){let f=await vs((_=e(l))==null?void 0:_.user_id,{purpose:"PasswordReset"}),n=await f.json();if(!f.ok){s(D,i(n.message)),s(N,!1);return}if(n.user_id!==e(l).user_id){s(D,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(E,i(n))}else await Se()}}async function Se(w){var n;if(!e(l))return;s(N,!0);const _={password:e(d).password,magic_link_id:e(l).magic_link_id,mfa_code:w},f=await ms(e(l).user_id,_,(n=e(l))==null?void 0:n.csrf_token);if(f.ok)s(D,""),s(d,i({passkeyName:"",password:"",passwordConfirm:""})),s(se,i(f.headers.get("Location"))),console.log("redirectUri: "+e(se)),s(g,!0);else{const L=await f.json();s(D,i(L.message))}s(N,!1)}function le(){s(E,void 0),s(D,i(r.mfa.errorReg))}function Oe(w){w&&(s(E,void 0),Se(w.code))}ge(()=>{r&&(s(Pe,i(He().shape({passkeyName:Ke().required(r.common.required).matches(us,r.mfa.passkeyNameErr)}))),s(We,i(He().shape({password:Ke().required(r.common.required),passwordConfirm:Ke().required(r.common.required)}))))}),ge(()=>{e(ee)&&s(d,i({passkeyName:"",password:"",passwordConfirm:""}))}),ge(()=>{var w;((w=e(d).password)==null?void 0:w.length)>0&&e(d).password===e(d).passwordConfirm&&s(ae,!0)}),ge(()=>{e(g)&&setTimeout(()=>{e(se)?window.location.replace(e(se)):Ae()},5e3)});var Ue=js();ns(w=>{var _=pe(),f=O(_);{var n=W=>{var G=pe(),ye=O(G);{var te=J=>{m(()=>Le.title=r.passwordReset.newAccount)},oe=J=>{var ce=pe(),$e=O(ce);{var _e=ue=>{m(()=>Le.title=r.passwordReset.passwordReset)};$($e,ue=>{e(M)==="password_reset"&&ue(_e)},!0)}o(J,ce)};$(ye,J=>{e(M).startsWith("new_user")?J(te):J(oe,!1)})}o(W,G)},L=W=>{Le.title="Password"};$(f,W=>{r?W(n):W(L,!1)})}o(w,_)});var Ge=O(Ue);ys(Ge,{id:cs,get value(){return e(l)},set value(w){s(l,i(w))}});var Je=t(Ge,2);ks(Je,{children:(w,_)=>{Rs(w,{children:(f,n)=>{var L=Es(),W=O(L);{var G=te=>{var oe=As(),J=k(oe);{var ce=A=>{var j=xs(),B=O(j);{var ke=a=>{Qe(a,{onSuccess:Oe,onError:le,get data(){return e(E)},set data(h){s(E,i(h))}})};$(B,a=>{e(E)&&a(ke)})}var F=t(B,2),we=k(F,!0);R(F);var Q=t(F,2),Re=k(Q,!0);R(Q);var X=t(Q,2),ie=k(X,!0),ve=t(ie);R(X);var T=t(X,2);ps(T,"margin-bottom","1rem");var de=k(T);z(de,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,i(a))},$$events:{click:()=>s(ee,"passkey")},children:(a,h)=>{C();var K=b();m(()=>u(K,r.passwordReset.passwordless)),o(a,K)},$$slots:{default:!0}});var Ce=t(de,2);z(Ce,{width:U,level:3,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,i(a))},$$events:{click:()=>s(ee,"password")},children:(a,h)=>{C();var K=b();m(()=>u(K,r.passwordReset.password)),o(a,K)},$$slots:{default:!0}}),R(T);var be=t(T,2);{var c=a=>{var h=Ds(),K=k(h);Be(K,{get policy(){return e(l).password_policy},get password(){return e(d).password},get accepted(){return e(re)},set accepted(v){s(re,i(v))}});var me=t(K,2);he(me,{get error(){return e(P).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Y,get showCopy(){return e(ae)},get disabled(){return e(g)},get value(){return e(d).password},set value(v){e(d).password=v},children:(v,I)=>{C();var p=b();m(()=>u(p,r.passwordReset.password.toUpperCase())),o(v,p)},$$slots:{default:!0}});var Z=t(me,2);he(Z,{get error(){return e(P).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Y,get showCopy(){return e(ae)},get disabled(){return e(g)},get value(){return e(d).passwordConfirm},set value(v){e(d).passwordConfirm=v},children:(v,I)=>{C();var p=b();m(()=>u(p,r.passwordReset.passwordConfirm.toUpperCase())),o(v,p)},$$slots:{default:!0}});var V=t(Z,2);z(V,{width:U,level:3,get isDisabled(){return e(g)},$$events:{click:Ee},children:(v,I)=>{C();var p=b();m(()=>u(p,r.passwordReset.generate)),o(v,p)},$$slots:{default:!0}});var ne=t(V,2);z(ne,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(v){s(N,i(v))},$$events:{click:Ie},children:(v,I)=>{C();var p=b();m(()=>u(p,r.common.save)),o(v,p)},$$slots:{default:!0}});var fe=t(ne,2);{var Ne=v=>{var I=Ns(),p=k(I),H=t(p,2);R(I),m(()=>{u(p,`${r.passwordReset.success1??""} `),u(H,` ${r.passwordReset.success2??""}`)}),o(v,I)};$(fe,v=>{e(g)&&v(Ne)})}R(h),Te(3,h,()=>Ve),o(a,h)},x=a=>{var h=pe(),K=O(h);{var me=Z=>{var V=Ks(),ne=k(V);ls(ne,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:Y,get disabled(){return e(g)},get value(){return e(d).passkeyName},set value(p){e(d).passkeyName=p},get error(){return e(P).passkeyName},set error(p){e(P).passkeyName=p},$$events:{enter:je},children:(p,H)=>{C();var S=b();m(()=>u(S,r.mfa.passkeyName)),o(p,S)},$$slots:{default:!0}});var fe=t(ne,2),Ne=ds(()=>e(g)?2:1);z(fe,{width:U,get level(){return e(Ne)},get isDisabled(){return e(g)},$$events:{click:je},children:(p,H)=>{C();var S=b();m(()=>u(S,r.mfa.register)),o(p,S)},$$slots:{default:!0}});var v=t(fe,2);{var I=p=>{var H=Ls(),S=k(H),es=k(S,!0);R(S);var De=t(S,2),ss=k(De,!0);R(De);var rs=t(De,2);z(rs,{width:U,level:1,$$events:{click:Ae},children:(as,Ss)=>{C();var ze=b();m(()=>u(ze,r.passwordReset.accountLogin)),o(as,ze)},$$slots:{default:!0}}),R(H),m(()=>{u(es,r.passwordReset.successPasskey1),u(ss,r.passwordReset.successPasskey2)}),o(p,H)};$(v,p=>{e(g)&&p(I)})}R(V),Te(3,V,()=>Ve),o(Z,V)};$(K,Z=>{e(ee)==="passkey"&&Z(me)},!0)}o(a,h)};$(be,a=>{e(ee)==="password"?a(c):a(x,!1)})}m(()=>{u(we,r.passwordReset.newAccount),u(Re,r.passwordReset.newAccDesc1),u(ie,r.passwordReset.newAccDesc2),Fe(ve,"href",r.passwordReset.fidoLink)}),o(A,j)},$e=A=>{var j=pe(),B=O(j);{var ke=F=>{var we=Ps(),Q=O(we);{var Re=c=>{Qe(c,{purpose:"PasswordReset",onSuccess:Oe,onError:le,get data(){return e(E)},set data(x){s(E,i(x))}})};$(Q,c=>{e(E)&&c(Re)})}var X=t(Q,4);Be(X,{get policy(){return e(l).password_policy},get password(){return e(d).password},get accepted(){return e(re)},set accepted(c){s(re,i(c))}});var ie=t(X,2);he(ie,{get error(){return e(P).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Y,get showCopy(){return e(ae)},get value(){return e(d).password},set value(c){e(d).password=c},children:(c,x)=>{C();var a=b();m(()=>u(a,r.passwordReset.password.toUpperCase())),o(c,a)},$$slots:{default:!0}});var ve=t(ie,2);he(ve,{get error(){return e(P).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Y,get showCopy(){return e(ae)},get value(){return e(d).passwordConfirm},set value(c){e(d).passwordConfirm=c},children:(c,x)=>{C();var a=b();m(()=>u(a,r.passwordReset.passwordConfirm.toUpperCase())),o(c,a)},$$slots:{default:!0}});var T=t(ve,2);z(T,{width:U,level:3,$$events:{click:Ee},children:(c,x)=>{C();var a=b();m(()=>u(a,r.passwordReset.generate)),o(c,a)},$$slots:{default:!0}});var de=t(T,2);z(de,{width:U,level:2,get isLoading(){return e(N)},set isLoading(c){s(N,i(c))},$$events:{click:Ie},children:(c,x)=>{C();var a=b();m(()=>u(a,r.common.save)),o(c,a)},$$slots:{default:!0}});var Ce=t(de,2);{var be=c=>{var x=qs(),a=k(x),h=t(a,2),K=t(h,3);R(x),m(()=>{u(a,`${r.passwordReset.success1??""}
                            ${r.passwordReset.success2??""} `),u(h,` ${r.passwordReset.success3??""} `),Fe(K,"href",e(se)||"/auth/v1/account")}),o(c,x)};$(Ce,c=>{e(g)&&c(be)})}o(F,we)};$(B,F=>{e(M).startsWith("password_reset")&&F(ke)},!0)}o(A,j)};$(J,A=>{e(M).startsWith("new_user")?A(ce):A($e,!1)})}var _e=t(J,2);{var ue=A=>{var j=Ws(),B=k(j,!0);R(j),m(()=>u(B,e(D))),o(A,j)};$(_e,A=>{e(D)&&A(ue)})}R(oe),o(te,oe)};$(W,te=>{e(l)&&te(G)})}var ye=t(W,2);bs(ye,{absolute:!0}),o(f,L)},$$slots:{default:!0}})},$$slots:{default:!0}});var Ye=t(Je,2);hs(Ye,{absolute:!0}),o(Xe,Ue),is()}export{Is as component};
