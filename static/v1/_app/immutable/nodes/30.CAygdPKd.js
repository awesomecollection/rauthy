import"../chunks/disclose-version.BDr9Qe-U.js";import{p as ts,a3 as y,o as os,a4 as O,a as is,j as s,a6 as m,$ as De,g as e,a5 as t,a7 as k,a9 as R,a8 as C,h as ds}from"../chunks/index-client.Cqn5bTAA.js";import{s as u}from"../chunks/render.BxZ_8nPF.js";import{i as $}from"../chunks/if.CfO-_epY.js";import{a as o,t as x,c as pe,b}from"../chunks/template.A7ni-K4i.js";import{h as ns}from"../chunks/svelte-head.DTZb8QfM.js";import{b as ps,s as Je,c as Me,d as Ge}from"../chunks/helpers.CZ9R9OcM.js";import{p as d}from"../chunks/proxy.Ce5Ub1RB.js";import{r as ge}from"../chunks/legacy-client.B3KsQmEJ.js";import{c as He,a as qe,I as ls}from"../chunks/Input.DikYy5qt.js";import{z as cs,u as us,A as ws,n as Te,B as vs,D as ms,E as fs,F as Ke,G as xe,H as gs}from"../chunks/dataFetching.BTF7Y2Cd.js";import{B as F}from"../chunks/Button.Ch35LVs2.js";import{P as Xe}from"../chunks/PasswordPolicy.DXpUlmha.js";import{P as he}from"../chunks/PasswordInput.PI3FNiBa.js";import{W as Be}from"../chunks/WebauthnRequest.CQBdNqvu.js";import{L as hs}from"../chunks/LangSelector.BJ1Lurmb.js";import"../chunks/is_dev.svelte.DT_BEvyo.js";import{u as ys}from"../chunks/i18n.svelte.CZcZQkVy.js";import{M as $s,C as _s}from"../chunks/ContentCenter.DAqX6TIP.js";import{T as ks}from"../chunks/Template.DXDiqOj9.js";import"../chunks/param.svelte.BjpJyl57.js";import{T as Rs}from"../chunks/ThemeSwitch.Nnphyg3I.js";var Cs=x('<div class="success svelte-14344wy"> <br> </div>'),bs=x("<div><!> <!> <!> <!> <!> <!></div>"),Ns=x('<div class="success svelte-14344wy"><p> </p> <p> </p> <!></div>'),Ls=x("<div><!> <!> <!></div>"),Ds=x('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-14344wy">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),qs=x('<div class="success svelte-14344wy"> <br> <br> <a class="svelte-14344wy">Link</a></div>'),Ks=x("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),xs=x('<div class="err svelte-14344wy"> </div>'),As=x('<div class="container"><!> <!></div>'),Ps=x("<!> <!>",1),Es=x("<!> <!> <!>",1);function Is(Ze,Qe){ts(Qe,!0);const U="150px",Q="320px";let r=ys(),l=y(void 0),N=y(!1),L=y(""),Y=y(""),ee=y(""),se=y(""),g=y(!1),re=y(!1),ae=y(!1),I=y(void 0),i=y(d({passkeyName:"",password:"",passwordConfirm:""})),A=y(d({})),Ae=y(void 0),Pe=y(void 0);os(async()=>{s(Y,"password_reset")});function Ee(){window.location.replace("/auth/v1/account")}function Ie(){if(e(l)){const w=e(l).password_policy.length_min>24?e(l).password_policy.length_min:24;let _=ws(w,e(l).password_policy.include_lower_case,e(l).password_policy.include_upper_case,e(l).password_policy.include_digits,e(l).password_policy.include_special);e(i).password=_,e(i).passwordConfirm=_}}async function je(){if(!e(l)){console.error("template data is undefined");return}s(L,"");try{await e(Ae).validate(e(i),{abortEarly:!1}),s(A,d({}))}catch(n){s(A,d(Te(n)));return}const w=e(i).passkeyName;if(w.length<2){s(L,d(r.mfa.passkeyNameErr));return}let _={passkey_name:w,magic_link_id:e(l).magic_link_id},f=await fs(e(l).user_id,_,e(l).csrf_token);if(f.status===200){let n=await f.json();n.publicKey.authenticatorSelection.userVerification="required",n.publicKey.challenge=Ke(n.publicKey.challenge),n.publicKey.user.id=Ke(n.publicKey.user.id),n.publicKey.excludeCredentials=n.publicKey.excludeCredentials,n.publicKey.excludeCredentials&&(n.publicKey.excludeCredentials=n.publicKey.excludeCredentials.map(V=>(V.id=Ke(V.id),V)));let D=await navigator.credentials.create(n),P={passkey_name:w,data:{id:D.id,rawId:xe(D.rawId),response:{attestationObject:xe(D.response.attestationObject),clientDataJSON:xe(D.response.clientDataJSON)},type:D.type},magic_link_id:e(l).magic_link_id};f=await gs(userId,P,e(l).csrf_token),f.status===201?(s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(g,!0)):(le(),console.error(f))}else{le();let n=await f.json();console.error(n.error),console.error(n.message)}}async function Se(){var w,_;try{await e(Pe).validate(e(i),{abortEarly:!1}),s(A,d({}))}catch(f){s(A,d(Te(f)));return}if(e(re)){if(e(i).password.length>256){s(L,"max 256");return}if(e(i).password!==e(i).passwordConfirm){s(L,d(r.passwordReset.passwordNoMatch));return}else s(L,"");if((w=e(l))!=null&&w.needs_mfa){let f=await vs((_=e(l))==null?void 0:_.user_id,{purpose:"PasswordReset"}),n=await f.json();if(!f.ok){s(L,d(n.message)),s(N,!1);return}if(n.user_id!==e(l).user_id){s(L,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(I,d(n))}else await We()}}async function We(w){var n;if(!e(l))return;s(N,!0);const _={password:e(i).password,magic_link_id:e(l).magic_link_id,mfa_code:w},f=await ms(e(l).user_id,_,(n=e(l))==null?void 0:n.csrf_token);if(f.ok)s(L,""),s(i,d({passkeyName:"",password:"",passwordConfirm:""})),s(se,d(f.headers.get("Location"))),console.log("redirectUri: "+e(se)),s(g,!0);else{const D=await f.json();s(L,d(D.message))}s(N,!1)}function le(){s(I,void 0),s(L,d(r.mfa.errorReg))}function Oe(w){w&&(s(I,void 0),We(w.code))}ge(()=>{r&&(s(Ae,d(He().shape({passkeyName:qe().required(r.common.required).matches(us,r.mfa.passkeyNameErr)}))),s(Pe,d(He().shape({password:qe().required(r.common.required),passwordConfirm:qe().required(r.common.required)}))))}),ge(()=>{e(ee)&&s(i,d({passkeyName:"",password:"",passwordConfirm:""}))}),ge(()=>{var w;((w=e(i).password)==null?void 0:w.length)>0&&e(i).password===e(i).passwordConfirm&&s(ae,!0)}),ge(()=>{e(g)&&setTimeout(()=>{e(se)?window.location.replace(e(se)):Ee()},5e3)});var Ue=Es();ns(w=>{var _=pe(),f=O(_);{var n=P=>{var V=pe(),ye=O(V);{var te=z=>{m(()=>De.title=r.passwordReset.newAccount)},oe=z=>{var ce=pe(),$e=O(ce);{var _e=ue=>{m(()=>De.title=r.passwordReset.passwordReset)};$($e,ue=>{e(Y)==="password_reset"&&ue(_e)},!0)}o(z,ce)};$(ye,z=>{e(Y).startsWith("new_user")?z(te):z(oe,!1)})}o(P,V)},D=P=>{De.title="Password"};$(f,P=>{r?P(n):P(D,!1)})}o(w,_)});var Ve=O(Ue);ks(Ve,{id:cs,get value(){return e(l)},set value(w){s(l,d(w))}});var ze=t(Ve,2);$s(ze,{children:(w,_)=>{_s(w,{children:(f,n)=>{var D=Ps(),P=O(D);{var V=te=>{var oe=As(),z=k(oe);{var ce=E=>{var j=Ds(),T=O(j);{var ke=a=>{Be(a,{onSuccess:Oe,onError:le,get data(){return e(I)},set data(h){s(I,d(h))}})};$(T,a=>{e(I)&&a(ke)})}var J=t(T,2),we=k(J,!0);R(J);var X=t(J,2),Re=k(X,!0);R(X);var B=t(X,2),ie=k(B,!0),ve=t(ie);R(B);var M=t(B,2);ps(M,"margin-bottom","1rem");var de=k(M);F(de,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(ee,"passkey")},children:(a,h)=>{C();var q=b();m(()=>u(q,r.passwordReset.passwordless)),o(a,q)},$$slots:{default:!0}});var Ce=t(de,2);F(Ce,{width:U,level:3,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(a){s(N,d(a))},$$events:{click:()=>s(ee,"password")},children:(a,h)=>{C();var q=b();m(()=>u(q,r.passwordReset.password)),o(a,q)},$$slots:{default:!0}}),R(M);var be=t(M,2);{var c=a=>{var h=bs(),q=k(h);Xe(q,{get policy(){return e(l).password_policy},get password(){return e(i).password},get accepted(){return e(re)},set accepted(v){s(re,d(v))}});var me=t(q,2);he(me,{get error(){return e(A).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(ae)},get disabled(){return e(g)},get value(){return e(i).password},set value(v){e(i).password=v},children:(v,S)=>{C();var p=b();m(()=>u(p,r.passwordReset.password.toUpperCase())),o(v,p)},$$slots:{default:!0}});var Z=t(me,2);he(Z,{get error(){return e(A).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(ae)},get disabled(){return e(g)},get value(){return e(i).passwordConfirm},set value(v){e(i).passwordConfirm=v},children:(v,S)=>{C();var p=b();m(()=>u(p,r.passwordReset.passwordConfirm.toUpperCase())),o(v,p)},$$slots:{default:!0}});var G=t(Z,2);F(G,{width:U,level:3,get isDisabled(){return e(g)},$$events:{click:Ie},children:(v,S)=>{C();var p=b();m(()=>u(p,r.passwordReset.generate)),o(v,p)},$$slots:{default:!0}});var ne=t(G,2);F(ne,{width:U,level:2,get isDisabled(){return e(g)},get isLoading(){return e(N)},set isLoading(v){s(N,d(v))},$$events:{click:Se},children:(v,S)=>{C();var p=b();m(()=>u(p,r.common.save)),o(v,p)},$$slots:{default:!0}});var fe=t(ne,2);{var Ne=v=>{var S=Cs(),p=k(S),H=t(p,2);R(S),m(()=>{u(p,`${r.passwordReset.success1??""} `),u(H,` ${r.passwordReset.success2??""}`)}),o(v,S)};$(fe,v=>{e(g)&&v(Ne)})}R(h),Me(3,h,()=>Ge),o(a,h)},K=a=>{var h=pe(),q=O(h);{var me=Z=>{var G=Ls(),ne=k(G);ls(ne,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:Q,get disabled(){return e(g)},get value(){return e(i).passkeyName},set value(p){e(i).passkeyName=p},get error(){return e(A).passkeyName},set error(p){e(A).passkeyName=p},$$events:{enter:je},children:(p,H)=>{C();var W=b();m(()=>u(W,r.mfa.passkeyName)),o(p,W)},$$slots:{default:!0}});var fe=t(ne,2),Ne=ds(()=>e(g)?2:1);F(fe,{width:U,get level(){return e(Ne)},get isDisabled(){return e(g)},$$events:{click:je},children:(p,H)=>{C();var W=b();m(()=>u(W,r.mfa.register)),o(p,W)},$$slots:{default:!0}});var v=t(fe,2);{var S=p=>{var H=Ns(),W=k(H),es=k(W,!0);R(W);var Le=t(W,2),ss=k(Le,!0);R(Le);var rs=t(Le,2);F(rs,{width:U,level:1,$$events:{click:Ee},children:(as,js)=>{C();var Fe=b();m(()=>u(Fe,r.passwordReset.accountLogin)),o(as,Fe)},$$slots:{default:!0}}),R(H),m(()=>{u(es,r.passwordReset.successPasskey1),u(ss,r.passwordReset.successPasskey2)}),o(p,H)};$(v,p=>{e(g)&&p(S)})}R(G),Me(3,G,()=>Ge),o(Z,G)};$(q,Z=>{e(ee)==="passkey"&&Z(me)},!0)}o(a,h)};$(be,a=>{e(ee)==="password"?a(c):a(K,!1)})}m(()=>{u(we,r.passwordReset.newAccount),u(Re,r.passwordReset.newAccDesc1),u(ie,r.passwordReset.newAccDesc2),Je(ve,"href",r.passwordReset.fidoLink)}),o(E,j)},$e=E=>{var j=pe(),T=O(j);{var ke=J=>{var we=Ks(),X=O(we);{var Re=c=>{Be(c,{purpose:"PasswordReset",onSuccess:Oe,onError:le,get data(){return e(I)},set data(K){s(I,d(K))}})};$(X,c=>{e(I)&&c(Re)})}var B=t(X,4);Xe(B,{get policy(){return e(l).password_policy},get password(){return e(i).password},get accepted(){return e(re)},set accepted(c){s(re,d(c))}});var ie=t(B,2);he(ie,{get error(){return e(A).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(ae)},get value(){return e(i).password},set value(c){e(i).password=c},children:(c,K)=>{C();var a=b();m(()=>u(a,r.passwordReset.password.toUpperCase())),o(c,a)},$$slots:{default:!0}});var ve=t(ie,2);he(ve,{get error(){return e(A).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(ae)},get value(){return e(i).passwordConfirm},set value(c){e(i).passwordConfirm=c},children:(c,K)=>{C();var a=b();m(()=>u(a,r.passwordReset.passwordConfirm.toUpperCase())),o(c,a)},$$slots:{default:!0}});var M=t(ve,2);F(M,{width:U,level:3,$$events:{click:Ie},children:(c,K)=>{C();var a=b();m(()=>u(a,r.passwordReset.generate)),o(c,a)},$$slots:{default:!0}});var de=t(M,2);F(de,{width:U,level:2,get isLoading(){return e(N)},set isLoading(c){s(N,d(c))},$$events:{click:Se},children:(c,K)=>{C();var a=b();m(()=>u(a,r.common.save)),o(c,a)},$$slots:{default:!0}});var Ce=t(de,2);{var be=c=>{var K=qs(),a=k(K),h=t(a,2),q=t(h,3);R(K),m(()=>{u(a,`${r.passwordReset.success1??""}
                            ${r.passwordReset.success2??""} `),u(h,` ${r.passwordReset.success3??""} `),Je(q,"href",e(se)||"/auth/v1/account")}),o(c,K)};$(Ce,c=>{e(g)&&c(be)})}o(J,we)};$(T,J=>{e(Y).startsWith("password_reset")&&J(ke)},!0)}o(E,j)};$(z,E=>{e(Y).startsWith("new_user")?E(ce):E($e,!1)})}var _e=t(z,2);{var ue=E=>{var j=xs(),T=k(j,!0);R(j),m(()=>u(T,e(L))),o(E,j)};$(_e,E=>{e(L)&&E(ue)})}R(oe),o(te,oe)};$(P,te=>{e(l)&&te(V)})}var ye=t(P,2);Rs(ye,{absolute:!0}),o(f,D)},$$slots:{default:!0}})},$$slots:{default:!0}});var Ye=t(ze,2);hs(Ye,{absolute:!0}),o(Ze,Ue),is()}export{Is as component};
