import"../chunks/disclose-version.BDr9Qe-U.js";import{p as es,P as g,o as ss,Q as B,a as rs,j as s,T as m,$ as ge,g as e,R as n,U as b,W as _,V as R,h as as}from"../chunks/index-client.CzqVbBUo.js";import{s as w}from"../chunks/render.DOFZNw8l.js";import{p,i as y}from"../chunks/if.BnegfJmL.js";import{a as l,b as J,c as ie,t as C}from"../chunks/template.C3U8HW1x.js";import{h as ts}from"../chunks/svelte-head.BSz900xL.js";import{L as os,B as T,t as Ue,s as je,a as Ae}from"../chunks/Button.65naIT6w.js";import{s as is}from"../chunks/helpers.BvaXa0cv.js";import{r as ue}from"../chunks/legacy-client.DtCljIS0.js";import{c as Se,a as he,I as ns}from"../chunks/Input.BRe7i--g.js";import{u as ds,z as ps,n as Je,A as ls,B as cs,D as us,E as $e,F as ye,G as ws}from"../chunks/dataFetching.BAMt2mQp.js";import{P as Oe}from"../chunks/PasswordPolicy.DA8XElUB.js";import{P as we}from"../chunks/PasswordInput.BNTSsZot.js";import{W as We}from"../chunks/WebauthnRequest.CgI5hSPb.js";import{L as vs}from"../chunks/LangSelector.Co2kZP41.js";import"../chunks/is_dev.svelte.BuX_eKSD.js";import{u as ms}from"../chunks/i18n.svelte.C_qSL0ZA.js";var fs=J('<div class="success svelte-189rvns"> <br> </div>'),gs=J("<div><!> <!> <!> <!> <!> <!></div>"),hs=J('<div class="success svelte-189rvns"><p> </p> <p> </p> <!></div>'),$s=J("<div><!> <!> <!></div>"),ys=J('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-189rvns">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),ks=J('<div class="success svelte-189rvns"> <br> <br> <a class="svelte-189rvns">Link</a></div>'),bs=J("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),_s=J('<div class="err svelte-189rvns"> </div>'),Rs=J('<!> <div class="container svelte-189rvns"><!> <!></div> <!>',1);function Cs(Be,Te){es(Te,!0);const O="150px",X="320px";let r=ms(),ne="",P=g(void 0),ke=g(!0),be=!1,N=g(!1),I=g(""),G="",Y=g(""),Z=g(""),de="",ee=g(void 0),f=g(!1),se=g(!1),re=g(!1),U=g(void 0),d=g(p({passkeyName:"",password:"",passwordConfirm:""})),q=g(p({})),_e=g(void 0),Re=g(void 0);ss(async()=>{let a;a="10, 128, 1, 1, 1, 1, 3";const t=[];a.split(",").forEach(i=>t.push(i)),s(P,p({length_min:Number.parseInt(t[0]),length_max:Number.parseInt(t[1]),include_lower_case:Number.parseInt(t[2]),include_upper_case:Number.parseInt(t[3]),include_digits:Number.parseInt(t[4]),include_special:Number.parseInt(t[5]),not_recently_used:Number.parseInt(t[6])})),be=t[7]=="true",ne=window.document.getElementsByName("rauthy-csrf-token")[0].id,G=window.location.href.split("/users/")[1].split("/")[0],de=window.location.href.split("/reset/")[1].split("?")[0],s(Y,"password_reset"),s(ke,!0)});function Ce(){window.location.replace("/auth/v1/account")}function Ne(){const a=e(P).length_min>24?e(P).length_min:24;let t=ps(a,e(P).include_lower_case,e(P).include_upper_case,e(P).include_digits,e(P).include_special);e(d).password=t,e(d).passwordConfirm=t}async function Ie(){s(I,"");try{await e(_e).validate(e(d),{abortEarly:!1}),s(q,p({}))}catch(i){s(q,p(Je(i)));return}const a=e(d).passkeyName;if(a.length<2){s(I,p(r.mfa.passkeyNameErr));return}let t=await us(G,{passkey_name:a,magic_link_id:de},ne);if(t.status===200){let i=await t.json();i.publicKey.authenticatorSelection.userVerification="required",i.publicKey.challenge=$e(i.publicKey.challenge),i.publicKey.user.id=$e(i.publicKey.user.id),i.publicKey.excludeCredentials=i.publicKey.excludeCredentials,i.publicKey.excludeCredentials&&(i.publicKey.excludeCredentials=i.publicKey.excludeCredentials.map(h=>(h.id=$e(h.id),h)));let k=await navigator.credentials.create(i),D={passkey_name:a,data:{id:k.id,rawId:ye(k.rawId),response:{attestationObject:ye(k.response.attestationObject),clientDataJSON:ye(k.response.clientDataJSON)},type:k.type},magic_link_id:de};t=await ws(G,D,ne),t.status===201?(s(d,p({passkeyName:"",password:"",passwordConfirm:""})),s(f,!0)):(pe(),console.error(t))}else{pe();let i=await t.json();console.error(i.error),console.error(i.message)}}async function Le(){try{await e(Re).validate(e(d),{abortEarly:!1}),s(q,p({}))}catch(a){s(q,p(Je(a)));return}if(e(se)){if(e(d).password.length>256){s(I,"max 256");return}if(e(d).password!==e(d).passwordConfirm){s(I,p(r.passwordReset.passwordNoMatch));return}else s(I,"");if(be){let a=await ls(G,{purpose:"PasswordReset"}),t=await a.json();if(!a.ok){s(I,p(t.message)),s(N,!1);return}if(t.user_id!==G){s(I,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(U,p(t))}else await De()}}async function De(a){s(N,!0);const t={password:e(d).password,magic_link_id:de,mfa_code:a},i=await cs(G,t,ne);if(i.ok)s(I,""),s(d,p({passkeyName:"",password:"",passwordConfirm:""})),s(ee,p(i.headers.get("Location"))),console.log("redirectUri: "+e(ee)),s(f,!0);else{const k=await i.json();s(I,p(k.message))}s(N,!1)}function pe(){s(U,void 0),s(I,p(r.mfa.errorReg))}function Ee(a){a&&(s(U,void 0),De(a.code))}ue(()=>{r&&(s(_e,p(Se().shape({passkeyName:he().required(r.common.required).matches(ds,r.mfa.passkeyNameErr)}))),s(Re,p(Se().shape({password:he().required(r.common.required),passwordConfirm:he().required(r.common.required)}))))}),ue(()=>{e(Z)&&s(d,p({passkeyName:"",password:"",passwordConfirm:""}))}),ue(()=>{var a;((a=e(d).password)==null?void 0:a.length)>0&&e(d).password===e(d).passwordConfirm&&s(re,!0)}),ue(()=>{e(f)&&setTimeout(()=>{e(ee)?window.location.replace(e(ee)):Ce()},5e3)});var qe=Rs();ts(a=>{var t=ie(),i=B(t);{var k=h=>{var j=ie(),ae=B(j);{var W=x=>{m(()=>ge.title=r.passwordReset.newAccount)},V=x=>{var K=ie(),F=B(K);{var te=z=>{m(()=>ge.title=r.passwordReset.passwordReset)};y(F,z=>{e(Y)==="password_reset"&&z(te)},!0)}l(x,K)};y(ae,x=>{e(Y).startsWith("new_user")?x(W):x(V,!1)})}l(h,j)},D=h=>{ge.title="Password"};y(i,h=>{r?h(k):h(D,!1)})}l(a,t)});var xe=B(qe);{var Ve=a=>{os(a,{})};y(xe,a=>{e(ke)||a(Ve)})}var ve=n(xe,2),Ke=b(ve);{var Fe=a=>{var t=ys(),i=B(t);{var k=o=>{We(o,{onSuccess:Ee,onError:pe,get data(){return e(U)},set data($){s(U,p($))}})};y(i,o=>{e(U)&&o(k)})}var D=n(i,2),h=b(D,!0);_(D);var j=n(D,2),ae=b(j,!0);_(j);var W=n(j,2),V=b(W,!0),x=n(V);_(W);var K=n(W,2);is(K,"margin-bottom","1rem");var F=b(K);T(F,{width:O,level:2,get isDisabled(){return e(f)},get isLoading(){return e(N)},set isLoading(o){s(N,p(o))},$$events:{click:()=>s(Z,"passkey")},children:(o,$)=>{R();var L=C();m(()=>w(L,r.passwordReset.passwordless)),l(o,L)},$$slots:{default:!0}});var te=n(F,2);T(te,{width:O,level:3,get isDisabled(){return e(f)},get isLoading(){return e(N)},set isLoading(o){s(N,p(o))},$$events:{click:()=>s(Z,"password")},children:(o,$)=>{R();var L=C();m(()=>w(L,r.passwordReset.password)),l(o,L)},$$slots:{default:!0}}),_(K);var z=n(K,2);{var u=o=>{var $=gs(),L=b($);Oe(L,{get policy(){return e(P)},get password(){return e(d).password},get accepted(){return e(se)},set accepted(v){s(se,p(v))}});var le=n(L,2);we(le,{get error(){return e(q).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:X,get showCopy(){return e(re)},get disabled(){return e(f)},get value(){return e(d).password},set value(v){e(d).password=v},children:(v,A)=>{R();var c=C();m(()=>w(c,r.passwordReset.password.toUpperCase())),l(v,c)},$$slots:{default:!0}});var H=n(le,2);we(H,{get error(){return e(q).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:X,get showCopy(){return e(re)},get disabled(){return e(f)},get value(){return e(d).passwordConfirm},set value(v){e(d).passwordConfirm=v},children:(v,A)=>{R();var c=C();m(()=>w(c,r.passwordReset.passwordConfirm.toUpperCase())),l(v,c)},$$slots:{default:!0}});var M=n(H,2);T(M,{width:O,level:3,get isDisabled(){return e(f)},$$events:{click:Ne},children:(v,A)=>{R();var c=C();m(()=>w(c,r.passwordReset.generate)),l(v,c)},$$slots:{default:!0}});var oe=n(M,2);T(oe,{width:O,level:2,get isDisabled(){return e(f)},get isLoading(){return e(N)},set isLoading(v){s(N,p(v))},$$events:{click:Le},children:(v,A)=>{R();var c=C();m(()=>w(c,r.common.save)),l(v,c)},$$slots:{default:!0}});var ce=n(oe,2);{var me=v=>{var A=fs(),c=b(A),Q=n(c,2);_(A),m(()=>{w(c,`${r.passwordReset.success1??""} `),w(Q,` ${r.passwordReset.success2??""}`)}),l(v,A)};y(ce,v=>{e(f)&&v(me)})}_($),Ue(3,$,()=>Ae),l(o,$)},E=o=>{var $=ie(),L=B($);{var le=H=>{var M=$s(),oe=b(M);ns(oe,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:X,get disabled(){return e(f)},get value(){return e(d).passkeyName},set value(c){e(d).passkeyName=c},get error(){return e(q).passkeyName},set error(c){e(q).passkeyName=c},$$events:{enter:Ie},children:(c,Q)=>{R();var S=C();m(()=>w(S,r.mfa.passkeyName)),l(c,S)},$$slots:{default:!0}});var ce=n(oe,2),me=as(()=>e(f)?2:1);T(ce,{width:O,get level(){return e(me)},get isDisabled(){return e(f)},$$events:{click:Ie},children:(c,Q)=>{R();var S=C();m(()=>w(S,r.mfa.register)),l(c,S)},$$slots:{default:!0}});var v=n(ce,2);{var A=c=>{var Q=hs(),S=b(Q),He=b(S,!0);_(S);var fe=n(S,2),Xe=b(fe,!0);_(fe);var Ye=n(fe,2);T(Ye,{width:O,level:1,$$events:{click:Ce},children:(Ze,Ns)=>{R();var Pe=C();m(()=>w(Pe,r.passwordReset.accountLogin)),l(Ze,Pe)},$$slots:{default:!0}}),_(Q),m(()=>{w(He,r.passwordReset.successPasskey1),w(Xe,r.passwordReset.successPasskey2)}),l(c,Q)};y(v,c=>{e(f)&&c(A)})}_(M),Ue(3,M,()=>Ae),l(H,M)};y(L,H=>{e(Z)==="passkey"&&H(le)},!0)}l(o,$)};y(z,o=>{e(Z)==="password"?o(u):o(E,!1)})}m(()=>{w(h,r.passwordReset.newAccount),w(ae,r.passwordReset.newAccDesc1),w(V,r.passwordReset.newAccDesc2),je(x,"href",r.passwordReset.fidoLink)}),l(a,t)},Me=a=>{var t=ie(),i=B(t);{var k=D=>{var h=bs(),j=B(h);{var ae=u=>{We(u,{purpose:"PasswordReset",onSuccess:Ee,onError:pe,get data(){return e(U)},set data(E){s(U,p(E))}})};y(j,u=>{e(U)&&u(ae)})}var W=n(j,4);Oe(W,{get policy(){return e(P)},get password(){return e(d).password},get accepted(){return e(se)},set accepted(u){s(se,p(u))}});var V=n(W,2);we(V,{get error(){return e(q).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:X,get showCopy(){return e(re)},get value(){return e(d).password},set value(u){e(d).password=u},children:(u,E)=>{R();var o=C();m(()=>w(o,r.passwordReset.password.toUpperCase())),l(u,o)},$$slots:{default:!0}});var x=n(V,2);we(x,{get error(){return e(q).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:X,get showCopy(){return e(re)},get value(){return e(d).passwordConfirm},set value(u){e(d).passwordConfirm=u},children:(u,E)=>{R();var o=C();m(()=>w(o,r.passwordReset.passwordConfirm.toUpperCase())),l(u,o)},$$slots:{default:!0}});var K=n(x,2);T(K,{width:O,level:3,$$events:{click:Ne},children:(u,E)=>{R();var o=C();m(()=>w(o,r.passwordReset.generate)),l(u,o)},$$slots:{default:!0}});var F=n(K,2);T(F,{width:O,level:2,get isLoading(){return e(N)},set isLoading(u){s(N,p(u))},$$events:{click:Le},children:(u,E)=>{R();var o=C();m(()=>w(o,r.common.save)),l(u,o)},$$slots:{default:!0}});var te=n(F,2);{var z=u=>{var E=ks(),o=b(E),$=n(o,2),L=n($,3);_(E),m(()=>{w(o,`${r.passwordReset.success1??""}
                ${r.passwordReset.success2??""} `),w($,` ${r.passwordReset.success3??""} `),je(L,"href",e(ee)||"/auth/v1/account")}),l(u,E)};y(te,u=>{e(f)&&u(z)})}l(D,h)};y(i,D=>{e(Y).startsWith("password_reset")&&D(k)},!0)}l(a,t)};y(Ke,a=>{e(Y).startsWith("new_user")?a(Fe):a(Me,!1)})}var Qe=n(Ke,2);{var Ge=a=>{var t=_s(),i=b(t,!0);_(t),m(()=>w(i,e(I))),l(a,t)};y(Qe,a=>{e(I)&&a(Ge)})}_(ve);var ze=n(ve,2);vs(ze,{absolute:!0}),l(Be,qe),rs()}export{Cs as component};
