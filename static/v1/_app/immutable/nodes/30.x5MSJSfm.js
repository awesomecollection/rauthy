import{a as p,b as U,c as ie,t as b}from"../chunks/disclose-version.C0dpEWi_.js";import{p as es,Z as g,o as ss,_ as F,a as rs,j as s,a1 as m,$ as ge,g as e,a0 as n,a2 as _,a4 as R,a3 as C,h as as}from"../chunks/index-client.LkyNpeLM.js";import{h as ts,s as w}from"../chunks/render.D21ACvZ4.js";import{i as y}from"../chunks/if.BQqAvi9S.js";import{L as os,t as We,a as je,s as Ae}from"../chunks/Loading.CZYfBo5y.js";import{v as is,q as ns,y as ds,n as Se,z as ps,A as ls,B as cs,D as he,E as $e,F as us}from"../chunks/dataFetching.C4rEqQY1.js";import{p as l}from"../chunks/proxy.bVSoDcUp.js";import{r as ue}from"../chunks/legacy-client.yBTdRgtG.js";import{c as Ue,a as ye,I as ws}from"../chunks/Input.BWHohn37.js";import{B}from"../chunks/Button.BDI_bIrm.js";import{P as Oe}from"../chunks/PasswordPolicy.Bw5rsarJ.js";import{P as we}from"../chunks/PasswordInput.j52NsKBe.js";import{W as ze}from"../chunks/WebauthnRequest.CDgCRlgS.js";import{L as vs}from"../chunks/LangSelector.PrFnGVsI.js";import"../chunks/is_dev.svelte.DMhPcyij.js";import{u as ms}from"../chunks/i18n.svelte.DPkpATkG.js";var fs=U('<div class="success svelte-189rvns"> <br> </div>'),gs=U("<div><!> <!> <!> <!> <!> <!></div>"),hs=U('<div class="success svelte-189rvns"><p> </p> <p> </p> <!></div>'),$s=U("<div><!> <!> <!></div>"),ys=U('<!> <h1> </h1> <p> </p> <p> <a target="_blank" class="svelte-189rvns">FIDO Alliance</a></p> <div><!> <!></div> <!>',1),ks=U('<div class="success svelte-189rvns"> <br> <br> <a class="svelte-189rvns">Link</a></div>'),bs=U("<!> <h1>Password Reset</h1> <!> <!> <!> <!> <!> <!>",1),_s=U('<div class="err svelte-189rvns"> </div>'),Rs=U('<!> <div class="container svelte-189rvns"><!> <!></div> <!>',1);function Cs(Fe,Be){es(Be,!0);const O="150px",Q="320px";let r=ms(),ne="",P=g(void 0),ke=g(!0),be=!1,N=g(!1),I=g(""),X="",G=g(""),Y=g(""),de="",ee=g(void 0),f=g(!1),se=g(!1),re=g(!1),W=g(void 0),d=g(l({passkeyName:"",password:"",passwordConfirm:""})),x=g(l({})),_e=g(void 0),Re=g(void 0);ss(async()=>{let a;a="10, 128, 1, 1, 1, 1, 3";const t=[];a.split(",").forEach(i=>t.push(i)),s(P,l({length_min:Number.parseInt(t[0]),length_max:Number.parseInt(t[1]),include_lower_case:Number.parseInt(t[2]),include_upper_case:Number.parseInt(t[3]),include_digits:Number.parseInt(t[4]),include_special:Number.parseInt(t[5]),not_recently_used:Number.parseInt(t[6])})),be=t[7]=="true",ne=window.document.getElementsByName("rauthy-csrf-token")[0].id,X=window.location.href.split("/users/")[1].split("/")[0],de=window.location.href.split("/reset/")[1].split("?")[0],s(G,"password_reset"),s(ke,!0)});function Ce(){window.location.replace("/auth/v1/account")}function Ne(){const a=e(P).length_min>24?e(P).length_min:24;let t=ds(a,e(P).include_lower_case,e(P).include_upper_case,e(P).include_digits,e(P).include_special);e(d).password=t,e(d).passwordConfirm=t}async function Ie(){s(I,"");try{await e(_e).validate(e(d),{abortEarly:!1}),s(x,l({}))}catch(i){s(x,l(Se(i)));return}const a=e(d).passkeyName;if(a.length<2){s(I,l(r.mfa.passkeyNameErr));return}let t=await cs(X,{passkey_name:a,magic_link_id:de},ne);if(t.status===200){let i=await t.json();i.publicKey.authenticatorSelection.userVerification="required",i.publicKey.challenge=he(i.publicKey.challenge),i.publicKey.user.id=he(i.publicKey.user.id),i.publicKey.excludeCredentials=i.publicKey.excludeCredentials,i.publicKey.excludeCredentials&&(i.publicKey.excludeCredentials=i.publicKey.excludeCredentials.map(h=>(h.id=he(h.id),h)));let k=await navigator.credentials.create(i),D={passkey_name:a,data:{id:k.id,rawId:$e(k.rawId),response:{attestationObject:$e(k.response.attestationObject),clientDataJSON:$e(k.response.clientDataJSON)},type:k.type},magic_link_id:de};t=await us(X,D,ne),t.status===201?(s(d,l({passkeyName:"",password:"",passwordConfirm:""})),s(f,!0)):(pe(),console.error(t))}else{pe();let i=await t.json();console.error(i.error),console.error(i.message)}}async function Le(){try{await e(Re).validate(e(d),{abortEarly:!1}),s(x,l({}))}catch(a){s(x,l(Se(a)));return}if(e(se)){if(e(d).password.length>256){s(I,"max 256");return}if(e(d).password!==e(d).passwordConfirm){s(I,l(r.passwordReset.passwordNoMatch));return}else s(I,"");if(be){let a=await ps(X,{purpose:"PasswordReset"}),t=await a.json();if(!a.ok){s(I,l(t.message)),s(N,!1);return}if(t.user_id!==X){s(I,"MFA user ID does not match - this should never happen"),s(N,!1);return}s(W,l(t))}else await De()}}async function De(a){s(N,!0);const t={password:e(d).password,magic_link_id:de,mfa_code:a},i=await ls(X,t,ne);if(i.ok)s(I,""),s(d,l({passkeyName:"",password:"",passwordConfirm:""})),s(ee,l(i.headers.get("Location"))),console.log("redirectUri: "+e(ee)),s(f,!0);else{const k=await i.json();s(I,l(k.message))}s(N,!1)}function pe(){s(W,void 0),s(I,l(r.mfa.errorReg))}function Ee(a){a&&(s(W,void 0),De(a.code))}ue(()=>{r&&(s(_e,l(Ue().shape({passkeyName:ye().required(r.common.required).matches(ns,r.mfa.passkeyNameErr)}))),s(Re,l(Ue().shape({password:ye().required(r.common.required),passwordConfirm:ye().required(r.common.required)}))))}),ue(()=>{e(Y)&&s(d,l({passkeyName:"",password:"",passwordConfirm:""}))}),ue(()=>{var a;((a=e(d).password)==null?void 0:a.length)>0&&e(d).password===e(d).passwordConfirm&&s(re,!0)}),ue(()=>{e(f)&&setTimeout(()=>{e(ee)?window.location.replace(e(ee)):Ce()},5e3)});var xe=Rs();ts(a=>{var t=ie(),i=F(t);{var k=h=>{var j=ie(),ae=F(j);{var z=K=>{m(()=>ge.title=r.passwordReset.newAccount)},J=K=>{var q=ie(),M=F(q);{var te=Z=>{m(()=>ge.title=r.passwordReset.passwordReset)};y(M,Z=>{e(G)==="password_reset"&&Z(te)},!0)}p(K,q)};y(ae,K=>{e(G).startsWith("new_user")?K(z):K(J,!1)})}p(h,j)},D=h=>{ge.title="Password"};y(i,h=>{r?h(k):h(D,!1)})}p(a,t)});var Ke=F(xe);{var Je=a=>{os(a,{})};y(Ke,a=>{e(ke)||a(Je)})}var ve=n(Ke,2),qe=_(ve);{var Me=a=>{var t=ys(),i=F(t);{var k=o=>{ze(o,{onSuccess:Ee,onError:pe,get data(){return e(W)},set data($){s(W,l($))}})};y(i,o=>{e(W)&&o(k)})}var D=n(i,2),h=_(D,!0);R(D);var j=n(D,2),ae=_(j,!0);R(j);var z=n(j,2),J=_(z,!0),K=n(J);R(z);var q=n(z,2);is(q,"margin-bottom","1rem");var M=_(q);B(M,{width:O,level:2,get isDisabled(){return e(f)},get isLoading(){return e(N)},set isLoading(o){s(N,l(o))},$$events:{click:()=>s(Y,"passkey")},children:(o,$)=>{C();var L=b();m(()=>w(L,r.passwordReset.passwordless)),p(o,L)},$$slots:{default:!0}});var te=n(M,2);B(te,{width:O,level:3,get isDisabled(){return e(f)},get isLoading(){return e(N)},set isLoading(o){s(N,l(o))},$$events:{click:()=>s(Y,"password")},children:(o,$)=>{C();var L=b();m(()=>w(L,r.passwordReset.password)),p(o,L)},$$slots:{default:!0}}),R(q);var Z=n(q,2);{var u=o=>{var $=gs(),L=_($);Oe(L,{get policy(){return e(P)},get password(){return e(d).password},get accepted(){return e(se)},set accepted(v){s(se,l(v))}});var le=n(L,2);we(le,{get error(){return e(x).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(re)},get disabled(){return e(f)},get value(){return e(d).password},set value(v){e(d).password=v},children:(v,A)=>{C();var c=b();m(()=>w(c,r.passwordReset.password.toUpperCase())),p(v,c)},$$slots:{default:!0}});var H=n(le,2);we(H,{get error(){return e(x).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(re)},get disabled(){return e(f)},get value(){return e(d).passwordConfirm},set value(v){e(d).passwordConfirm=v},children:(v,A)=>{C();var c=b();m(()=>w(c,r.passwordReset.passwordConfirm.toUpperCase())),p(v,c)},$$slots:{default:!0}});var T=n(H,2);B(T,{width:O,level:3,get isDisabled(){return e(f)},$$events:{click:Ne},children:(v,A)=>{C();var c=b();m(()=>w(c,r.passwordReset.generate)),p(v,c)},$$slots:{default:!0}});var oe=n(T,2);B(oe,{width:O,level:2,get isDisabled(){return e(f)},get isLoading(){return e(N)},set isLoading(v){s(N,l(v))},$$events:{click:Le},children:(v,A)=>{C();var c=b();m(()=>w(c,r.common.save)),p(v,c)},$$slots:{default:!0}});var ce=n(oe,2);{var me=v=>{var A=fs(),c=_(A),V=n(c,2);R(A),m(()=>{w(c,`${r.passwordReset.success1??""} `),w(V,` ${r.passwordReset.success2??""}`)}),p(v,A)};y(ce,v=>{e(f)&&v(me)})}R($),We(3,$,()=>je),p(o,$)},E=o=>{var $=ie(),L=F($);{var le=H=>{var T=$s(),oe=_(T);ws(oe,{autocomplete:"off",get placeholder(){return r.mfa.passkeyName},width:Q,get disabled(){return e(f)},get value(){return e(d).passkeyName},set value(c){e(d).passkeyName=c},get error(){return e(x).passkeyName},set error(c){e(x).passkeyName=c},$$events:{enter:Ie},children:(c,V)=>{C();var S=b();m(()=>w(S,r.mfa.passkeyName)),p(c,S)},$$slots:{default:!0}});var ce=n(oe,2),me=as(()=>e(f)?2:1);B(ce,{width:O,get level(){return e(me)},get isDisabled(){return e(f)},$$events:{click:Ie},children:(c,V)=>{C();var S=b();m(()=>w(S,r.mfa.register)),p(c,S)},$$slots:{default:!0}});var v=n(ce,2);{var A=c=>{var V=hs(),S=_(V),He=_(S,!0);R(S);var fe=n(S,2),Qe=_(fe,!0);R(fe);var Ge=n(fe,2);B(Ge,{width:O,level:1,$$events:{click:Ce},children:(Ye,Ns)=>{C();var Pe=b();m(()=>w(Pe,r.passwordReset.accountLogin)),p(Ye,Pe)},$$slots:{default:!0}}),R(V),m(()=>{w(He,r.passwordReset.successPasskey1),w(Qe,r.passwordReset.successPasskey2)}),p(c,V)};y(v,c=>{e(f)&&c(A)})}R(T),We(3,T,()=>je),p(H,T)};y(L,H=>{e(Y)==="passkey"&&H(le)},!0)}p(o,$)};y(Z,o=>{e(Y)==="password"?o(u):o(E,!1)})}m(()=>{w(h,r.passwordReset.newAccount),w(ae,r.passwordReset.newAccDesc1),w(J,r.passwordReset.newAccDesc2),Ae(K,"href",r.passwordReset.fidoLink)}),p(a,t)},Te=a=>{var t=ie(),i=F(t);{var k=D=>{var h=bs(),j=F(h);{var ae=u=>{ze(u,{purpose:"PasswordReset",onSuccess:Ee,onError:pe,get data(){return e(W)},set data(E){s(W,l(E))}})};y(j,u=>{e(W)&&u(ae)})}var z=n(j,4);Oe(z,{get policy(){return e(P)},get password(){return e(d).password},get accepted(){return e(se)},set accepted(u){s(se,l(u))}});var J=n(z,2);we(J,{get error(){return e(x).password},autocomplete:"new-password",get placeholder(){return r.passwordReset.password},width:Q,get showCopy(){return e(re)},get value(){return e(d).password},set value(u){e(d).password=u},children:(u,E)=>{C();var o=b();m(()=>w(o,r.passwordReset.password.toUpperCase())),p(u,o)},$$slots:{default:!0}});var K=n(J,2);we(K,{get error(){return e(x).passwordConfirm},autocomplete:"new-password",get placeholder(){return r.passwordReset.passwordConfirm},width:Q,get showCopy(){return e(re)},get value(){return e(d).passwordConfirm},set value(u){e(d).passwordConfirm=u},children:(u,E)=>{C();var o=b();m(()=>w(o,r.passwordReset.passwordConfirm.toUpperCase())),p(u,o)},$$slots:{default:!0}});var q=n(K,2);B(q,{width:O,level:3,$$events:{click:Ne},children:(u,E)=>{C();var o=b();m(()=>w(o,r.passwordReset.generate)),p(u,o)},$$slots:{default:!0}});var M=n(q,2);B(M,{width:O,level:2,get isLoading(){return e(N)},set isLoading(u){s(N,l(u))},$$events:{click:Le},children:(u,E)=>{C();var o=b();m(()=>w(o,r.common.save)),p(u,o)},$$slots:{default:!0}});var te=n(M,2);{var Z=u=>{var E=ks(),o=_(E),$=n(o,2),L=n($,3);R(E),m(()=>{w(o,`${r.passwordReset.success1??""}
                ${r.passwordReset.success2??""} `),w($,` ${r.passwordReset.success3??""} `),Ae(L,"href",e(ee)||"/auth/v1/account")}),p(u,E)};y(te,u=>{e(f)&&u(Z)})}p(D,h)};y(i,D=>{e(G).startsWith("password_reset")&&D(k)},!0)}p(a,t)};y(qe,a=>{e(G).startsWith("new_user")?a(Me):a(Te,!1)})}var Ve=n(qe,2);{var Xe=a=>{var t=_s(),i=_(t,!0);R(t),m(()=>w(i,e(I))),p(a,t)};y(Ve,a=>{e(I)&&a(Xe)})}R(ve);var Ze=n(ve,2);vs(Ze,{absolute:!0}),p(Fe,xe),rs()}export{Cs as component};
